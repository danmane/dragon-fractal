<head>
  <meta charset="UTF-8">
  <script src="bower_components/d3/d3.js"></script>
  <script>!function(){function t(t){return function(e,i){e=d3.hsl(e),i=d3.hsl(i);var r=(e.h+120)*a,h=(i.h+120)*a-r,s=e.s,l=i.s-s,o=e.l,u=i.l-o;return isNaN(l)&&(l=0,s=isNaN(s)?i.s:s),isNaN(h)&&(h=0,r=isNaN(r)?i.h:r),function(a){var e=r+h*a,i=Math.pow(o+u*a,t),c=(s+l*a)*i*(1-i);return"#"+n(i+c*(-.14861*Math.cos(e)+1.78277*Math.sin(e)))+n(i+c*(-.29227*Math.cos(e)-.90649*Math.sin(e)))+n(i+c*1.97294*Math.cos(e))}}}function n(t){var n=(t=0>=t?0:t>=1?255:0|255*t).toString(16);return 16>t?"0"+n:n}var a=Math.PI/180;d3.scale.cubehelix=function(){return d3.scale.linear().range([d3.hsl(300,.5,0),d3.hsl(-240,.5,1)]).interpolate(d3.interpolateCubehelix)},d3.interpolateCubehelix=t(1),d3.interpolateCubehelix.gamma=t}();</script>
</head>
<body>
  <style>
    #main {width: 100%; height: 100%; background-color: black;}
    path {stroke-width: 2px; stroke-linecap: square;}
    body {margin: 0px;}
  </style>
  <svg id="main">
    <g id="xform" transform="translate(1000, 505)">
      <circle r="5" fill="white" />
      <g id="origin">
        <g id="start"><path id="p" d="M 0 0 L 1 0"/></g>
      </g>
    </g>
  </svg>
  <script>
  next = false
  h=d3.hsl,cs = d3.scale.cubehelix().domain([-0.2, 0.5, 1])
    .range([h(-100, 0.75, 0.35),h(80,1.50,0.80),h(260, 0.75, 0.35)])
  x=10, y=0, id=0, d=100, ds=1.1, o=d3.select("#origin"), max=13;
  pd = "M 0 0 L " + x + " 0";
  d3.select("#p").style("stroke", cs(0)).transition().duration(d).attr("d", pd);
  setTimeout(update, d);
  function update() {
    id = (id + 1) % (max * 2);
    console.log(id);
    a = "rotate(0 " + [x,y] + ")", b = "rotate(90 " + [x,y] + ")"
    w = function() {return d3.interpolateString(a,b)}
    last = o.node().children[o.node().children.length-1]
    if (id < max) {
      last.style = "stroke: " + cs((id-1) / max)
      Array.prototype.forEach.call(last.children, function(x) {x.style=""})
      clone = o.node().cloneNode(true)
      g=d3.select(o.node().appendChild(clone))
      g.selectAll("g").transition().duration(d).style("stroke", cs(id/max))
      g.transition().duration(d).attrTween("transform", w)
      _x = x+y, y = -x+y, x = _x, d = (d) * ds;
      setTimeout(update, d);
    } else {
      if (next) next.remove()
      y = (y+x)/2, x -= y
      a = "rotate(0 " + [x,y] + ")", b = "rotate(90 " + [x,y] + ")"
      w = function() {return d3.interpolateString(a,b)}
      children = o.node().children, next = children[children.length-1]
      o = o.append("g")
      while (children.length > 2) {
        o.node().appendChild(children[0])
      }
      o.transition().duration(d).attrTween("transform", w)
      setTimeout(update, d);
    }
  }
  </script>
</body>
